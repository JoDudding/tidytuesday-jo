---
title: "#TidyTuesday 2025-05-20: Water Quality at Sydney Beaches"
format: html
execute: 
  freeze: auto
---

# Background

This week we're exploring the water quality of Sydney's iconic beaches. The data is available at the New South Wales State Government [Beachwatch website](https://www.beachwatch.nsw.gov.au/waterMonitoring/waterQualityData).

> Beachwatch and our partners monitor water quality at swim sites to ensure that recreational water environments are managed as safely as possible so that as many people as possible can benefit from using the water.

[Sydney beaches were in the news](https://www.abc.net.au/news/2025-01-10/pollution-risks-in-sydney-beaches-contaminated-waterways-rain/104790856.) this summer with high rainfall causing concerns about the safety of the water.

The dataset this week includes both water quality and [historical weather data](https://open-meteo.com/) from 1991 until 2025.

- Has the water quality declined over this period?
- How does rainfall impact E-coli bacteria levels?
- Are some swimming sites particularly prone to high bacteria levels following rain?

```{r}
#| label: setup
#| file: scripts/_setup.r

library(leaflet, quietly = TRUE)
library(gt, quietly = TRUE)
```

# Load the weekly data and check the [readme](https://github.com/rfordatascience/tidytuesday/tree/main/data/2025/2025-05-20)

```{r}
#| label: load-data
#| include: false

if(file.exists("data/tt_2025-05-20.rds")) {
  tt <- readRDS("data/tt_2025-05-20.rds")
} else {

  tt <- tt_load("2025-05-20")
  saveRDS(tt, "data/tt_2025-05-20.rds")
}

map(tt, glimpse)

```



# Analyse

## Ideas

- leaflet map
- popup with a sparkline
- change in extreme rainfall days

## Weather trends

```{r}
#| label: fig-cum-rainfall
#| fig-cap: Cumulative rainfall for Sydney

cum_annual_rainfall <- tt$weather |> 
  group_by(year = year(date)) |> 
  arrange(date) |> 
  mutate(
    cum_precip = cumsum(precipitation_mm),
    month = month(date, label = TRUE)
  ) |> 
  # remove the leap days
  filter(! (month(date) == 2 & day(date) == 29)) |> 
  mutate(
    day = row_number(),
    max_year= last(cum_precip)
  ) |> 
  ungroup() |> 
  mutate(
    year_groups = case_when(
      year == max(year) ~ as.character(year),
      max_year == max(max_year) ~ as.character(year),
      TRUE ~ "Rest"
    )
  )

quartiles <- cum_annual_rainfall |> 
  group_by(day) |> 
  summarise(
    "1" = quantile(cum_precip, 0.25),
    "2" = quantile(cum_precip, 0.50),
    "3" = quantile(cum_precip, 0.75)
  ) |> 
  gather(-day, key = year, value = cum_precip) |> 
  mutate(
    year = as.integer(year),
    year_groups = "Quartiles"
  )

cum_annual_rainfall |> 
  bind_rows(quartiles) |> 
  ggplot(aes(day, cum_precip, group = year, colour = year_groups,
      linewidth = year_groups)) +
  geom_line() +
  scale_y_c() +
  scale_colour_manual(values = 
    c(pulse$teal, pulse$purple, pulse$pink, pulse$grey_50)) +
  scale_linewidth_manual(values = c(0.7, 0.7, 0.6, 0.2)) +
  labs(
    x = "Day of year", 
    y = "Year to date rainfall", 
    colour = NULL,
    title = "Cummulative annual rainfall for Sydney",
    subtitle = glue(
      "{min(cum_annual_rainfall$year)}-{max(cum_annual_rainfall$year)}"
    )
  ) +
  guides(linewidth = "none")


```

```{r}
#| label: fig-annual-rainfall
#| fig-cap: Annual rainfall for Sydney

cum_annual_rainfall |> 
  filter(day == max(day)) |> 
  ggplot(aes(year, cum_precip, fill = year_groups)) +
  geom_col() +
  geom_smooth(method = "lm", se = FALSE, formula = y ~ x, 
    colour = pulse$secondary) +
  scale_x_continuous(breaks = seq(1990, 2030, by = 5)) +
  scale_y_c() +
  scale_fill_manual(values = 
    c(pulse$teal, pulse$purple, pulse$pink, pulse$grey_50)) +
  guides(fill = "none") +
  labs(
    x = "Year",
    y = "Annual rainfall",
    title = "Annual rainfall has been increasing",
    subtitle = "Trend of annual rainfall for Sydney"
  )

```

